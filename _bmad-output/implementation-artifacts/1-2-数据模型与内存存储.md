# Story 1.2: 数据模型与内存存储

Status: done

## Story

As a 开发者,
I want 定义所有核心 Pydantic 数据模型和内存状态管理模块,
so that 后续的 Agent 引擎、API 层和前端都有统一的数据契约。

## Acceptance Criteria

1. **Given** schemas/models.py **When** 定义数据模型 **Then** 包含以下 Pydantic 模型：AgentExecutionState、ActionLogEntry、ChannelMessage、SkillDefinition、ToolDefinition、ExecutionHistory

2. **Given** ActionLogEntry 模型 **When** 查看字段定义 **Then** 包含 index(int)、action_type(枚举：intent_recognition/skill_loaded/tool_call/waiting/message_sent/completed)、title(str)、summary(str)、status(枚举：running/success/error)、detail(dict, optional)、timestamp(datetime)

3. **Given** ChannelMessage 模型 **When** 查看字段定义 **Then** 包含 channel(枚举：chat/downstream/upstream)、sender(str)、content(str)、timestamp(datetime)

4. **Given** AgentExecutionState 模型 **When** 查看字段定义 **Then** 包含 session_id(str)、status(枚举：idle/running/completed/error)、actions(list[ActionLogEntry])、final_reply(str, optional)、unread_channels(list[str])

5. **Given** store/memory.py **When** 实例化内存存储 **Then** 提供会话状态的创建/读取/更新、消息的添加/按频道查询、动作日志的追加/增量查询功能

6. **Given** 内存存储模块 **When** 调用 add_action 添加一条动作后以 get_actions(after_index=N) 查询 **Then** 仅返回 index > N 的增量动作记录

## Tasks / Subtasks

- [x] Task 1: 定义枚举类型 (AC: #2, #3, #4)
  - [x] 1.1 在 `backend/app/schemas/models.py` 中定义 `ActionType` 枚举（intent_recognition、skill_loaded、tool_call、waiting、message_sent、completed）
  - [x] 1.2 定义 `ActionStatus` 枚举（running、success、error）
  - [x] 1.3 定义 `SessionStatus` 枚举（idle、running、completed、error）
  - [x] 1.4 定义 `Channel` 枚举（chat、downstream、upstream）

- [x] Task 2: 定义 Pydantic 数据模型 (AC: #1, #2, #3, #4)
  - [x] 2.1 定义 `ActionLogEntry` 模型（index, action_type, title, summary, status, detail, timestamp）
  - [x] 2.2 定义 `ChannelMessage` 模型（channel, sender, content, timestamp）
  - [x] 2.3 定义 `AgentExecutionState` 模型（session_id, status, actions, final_reply, unread_channels）
  - [x] 2.4 定义 `SkillDefinition` 模型（skill_id, name, description, content）
  - [x] 2.5 定义 `ToolDefinition` 模型（name, description, parameters）
  - [x] 2.6 定义 `ExecutionHistory` 模型（execution_id, trigger_message, skill_name, status, actions, created_at）

- [x] Task 3: 实现内存存储模块 (AC: #5, #6)
  - [x] 3.1 在 `backend/app/store/memory.py` 中创建 `MemoryStore` 类
  - [x] 3.2 实现会话状态管理：create_session、get_session、update_session_status、set_final_reply
  - [x] 3.3 实现动作日志管理：add_action（自动分配递增 index）、get_actions(after_index) 增量查询
  - [x] 3.4 实现消息管理：add_message、get_messages(channel) 按频道查询
  - [x] 3.5 实现未读频道管理：mark_channel_unread、clear_channel_unread
  - [x] 3.6 实现历史记录管理：save_execution_history、get_history_list、get_history_detail
  - [x] 3.7 实现清空会话功能：clear_session（重置所有状态）

- [x] Task 4: 编写单元测试 (AC: #1-#6)
  - [x] 4.1 在 `backend/tests/test_models.py` 中测试所有 Pydantic 模型的创建和序列化
  - [x] 4.2 在 `backend/tests/test_store.py` 中测试 MemoryStore 的会话管理功能
  - [x] 4.3 测试 add_action + get_actions(after_index=N) 增量查询逻辑
  - [x] 4.4 测试消息的添加和按频道查询
  - [x] 4.5 测试清空会话后状态完全重置

## Dev Notes

### 技术栈版本（已验证 2026-02-26）

| 库 | 安装版本 | 说明 |
|---|---|---|
| Pydantic | 2.12.5 | FastAPI 内置，v2 API |
| FastAPI | 0.133.1 | 已安装并运行 |
| Python | 3.12+ | 支持 `str \| None` 语法 |

### Pydantic v2 模型定义规范

使用 Pydantic v2 API，**禁止**使用已废弃的 v1 API：

```python
# ✅ 正确 — Pydantic v2
from pydantic import BaseModel, Field, ConfigDict
from enum import Enum
from datetime import datetime

class ActionType(str, Enum):
    intent_recognition = "intent_recognition"
    skill_loaded = "skill_loaded"
    tool_call = "tool_call"
    waiting = "waiting"
    message_sent = "message_sent"
    completed = "completed"

class ActionLogEntry(BaseModel):
    index: int
    action_type: ActionType
    title: str
    summary: str
    status: ActionStatus
    detail: dict | None = None
    timestamp: datetime = Field(default_factory=datetime.now)
```

```python
# ❌ 禁止 — Pydantic v1 废弃 API
from pydantic import validator  # 用 field_validator 替代
class Config:                   # 用 model_config = ConfigDict(...) 替代
    orm_mode = True             # 用 from_attributes = True 替代
```

### 枚举值定义（架构文档已锁定）

以下枚举值**必须**与架构文档完全一致，前端 TypeScript 类型将与之对应：

**ActionType（动作类型）：**
- `intent_recognition` — 意图识别
- `skill_loaded` — Skill 加载
- `tool_call` — 工具调用
- `waiting` — 等待外部回复
- `message_sent` — 消息发送
- `completed` — 流程完成

**ActionStatus（动作状态）：**
- `running` — 执行中
- `success` — 成功
- `error` — 失败

**SessionStatus（会话状态）：**
- `idle` — 空闲
- `running` — Agent 执行中
- `completed` — 流程完成
- `error` — 流程异常终止

**Channel（频道标识）：**
- `chat` — 对话频道
- `downstream` — 下游群
- `upstream` — 上游群

### 数据模型字段详细规格

**ActionLogEntry：**
| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| index | int | ✅ | — | 自动递增，由 MemoryStore 分配 |
| action_type | ActionType | ✅ | — | 枚举值，见上 |
| title | str | ✅ | — | 步骤标题，如"调用工具：查询订单" |
| summary | str | ✅ | — | 步骤摘要，如"查询订单号 HT20260301001" |
| status | ActionStatus | ✅ | — | 运行/成功/失败 |
| detail | dict \| None | ❌ | None | 工具调用的输入/输出详情 |
| timestamp | datetime | ❌ | datetime.now() | 自动生成时间戳 |

**ChannelMessage：**
| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| channel | Channel | ✅ | — | chat/downstream/upstream |
| sender | str | ✅ | — | 发送者标识：user/agent/supplier |
| content | str | ✅ | — | 消息内容 |
| timestamp | datetime | ❌ | datetime.now() | 自动生成时间戳 |

**AgentExecutionState：**
| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| session_id | str | ✅ | — | UUID 格式字符串 |
| status | SessionStatus | ✅ | idle | 会话级状态 |
| actions | list[ActionLogEntry] | ✅ | [] | 动作日志列表 |
| final_reply | str \| None | ❌ | None | Agent 最终回复 |
| unread_channels | list[str] | ✅ | [] | 有未读消息的频道标识 |

**SkillDefinition：**
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| skill_id | str | ✅ | 标识符，如 early_checkout |
| name | str | ✅ | 显示名称，如"提前离店" |
| description | str | ✅ | 简要描述 |
| content | str | ✅ | .md 文件完整内容 |

**ToolDefinition：**
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | str | ✅ | 工具名称，如 order_query |
| description | str | ✅ | 功能说明 |
| parameters | dict | ✅ | 参数描述（名称→类型+说明的字典） |

**ExecutionHistory：**
| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| execution_id | str | ✅ | — | UUID 格式字符串 |
| trigger_message | str | ✅ | — | 触发消息内容 |
| skill_name | str \| None | ❌ | None | 匹配的 Skill 名称（未匹配时为 None） |
| status | SessionStatus | ✅ | — | 最终执行状态 |
| actions | list[ActionLogEntry] | ✅ | — | 完整动作日志快照 |
| created_at | datetime | ❌ | datetime.now() | 执行时间 |

### MemoryStore 内存存储设计

```python
# store/memory.py — 核心结构

class MemoryStore:
    """单例内存存储，管理会话状态、消息、历史记录。"""

    def __init__(self):
        self._session: AgentExecutionState | None = None
        self._messages: list[ChannelMessage] = []
        self._history: list[ExecutionHistory] = []
        self._action_counter: int = 0  # 动作 index 自增计数器

    # === 会话管理 ===
    def create_session(self) -> AgentExecutionState: ...
    def get_session(self) -> AgentExecutionState | None: ...
    def update_session_status(self, status: SessionStatus) -> None: ...
    def set_final_reply(self, reply: str) -> None: ...

    # === 动作日志 ===
    def add_action(self, action_type, title, summary, status, detail=None) -> ActionLogEntry: ...
    def update_action_status(self, index: int, status: ActionStatus, detail=None) -> None: ...
    def get_actions(self, after_index: int = -1) -> list[ActionLogEntry]: ...

    # === 消息管理 ===
    def add_message(self, channel, sender, content) -> ChannelMessage: ...
    def get_messages(self, channel: Channel) -> list[ChannelMessage]: ...

    # === 未读频道 ===
    def mark_channel_unread(self, channel: str) -> None: ...
    def clear_channel_unread(self, channel: str) -> None: ...

    # === 历史记录 ===
    def save_execution_history(self, trigger_message: str) -> ExecutionHistory: ...
    def get_history_list(self) -> list[ExecutionHistory]: ...
    def get_history_detail(self, execution_id: str) -> ExecutionHistory | None: ...

    # === 会话重置 ===
    def clear_session(self) -> None: ...
```

**关键设计决策：**

1. **单例模式** — 全局唯一 `MemoryStore` 实例（模块级变量 `store = MemoryStore()`），所有 router 和 agent engine 共享同一实例
2. **自增 index** — `add_action` 自动分配递增 index，调用者无需关心
3. **增量查询** — `get_actions(after_index=N)` 返回 `index > N` 的记录，支持前端轮询只获取新数据
4. **快照式历史** — `save_execution_history` 深拷贝当前 actions 列表，确保历史记录不受后续操作影响
5. **清空重置** — `clear_session` 重置 session、messages、action_counter，但**保留** history（历史记录跨会话持久）

### 轮询 API 响应结构（前端消费格式）

MemoryStore 的设计需要支持以下轮询响应格式（由 Story 1.5 的 router 组装）：

```json
{
  "session_id": "xxx",
  "status": "running",
  "new_actions": [
    {
      "index": 4,
      "action_type": "tool_call",
      "title": "调用工具：查询订单",
      "summary": "查询订单号 HT20260301001",
      "status": "success",
      "detail": { "input": {}, "output": {} },
      "timestamp": "2026-02-26T14:30:01Z"
    }
  ],
  "unread_channels": ["upstream"],
  "final_reply": null
}
```

### 错误响应格式

API 错误响应（由 Story 1.5 实现，但数据模型需预留支持）：

```json
{
  "error": true,
  "error_type": "SESSION_NOT_FOUND",
  "message": "会话不存在"
}
```

### 命名规范

| 场景 | 规则 | 示例 |
|------|------|------|
| Python 变量/函数 | snake_case | `get_actions`, `after_index` |
| Python 类名 | PascalCase | `AgentExecutionState`, `MemoryStore` |
| Python 文件名 | snake_case | `models.py`, `memory.py` |
| 枚举类名 | PascalCase | `ActionType`, `SessionStatus` |
| 枚举值 | snake_case 字符串 | `"intent_recognition"`, `"tool_call"` |
| JSON 序列化字段 | snake_case | `action_type`, `session_id` |

### 文件结构

本 Story 涉及的文件：

```
backend/app/
├── schemas/
│   ├── __init__.py          # 空（已存在）
│   └── models.py            # 新增：全部 Pydantic 模型和枚举
└── store/
    ├── __init__.py           # 空（已存在）
    └── memory.py             # 新增：MemoryStore 内存存储

backend/tests/
├── __init__.py               # 空（已存在）
├── test_models.py            # 新增：模型单元测试
└── test_store.py             # 新增：存储单元测试
```

### 架构边界提醒

本 Story **只做**数据模型和内存存储：

**只做：**
- 定义 Pydantic 模型和枚举
- 实现 MemoryStore 内存管理类
- 编写单元测试

**禁止：**
- 创建任何 API 路由（Story 1.5 负责）
- 实现 Agent 引擎逻辑（Story 1.4 负责）
- 实现工具类（Story 1.3 负责）
- 在 main.py 中注册路由
- 创建前端类型定义（Story 1.6 负责）

### Project Structure Notes

- `schemas/models.py` 是所有模型的集中定义点，后续 Story 的 router、engine、tools 都从此导入
- `store/memory.py` 导出模块级 `store` 实例，后续 Story 通过 `from app.store.memory import store` 使用
- 所有枚举使用 `str, Enum` 双继承，确保 JSON 序列化输出字符串值而非枚举对象名

### 前一个 Story (1.1) 关键信息

- 项目骨架已创建，所有 `__init__.py` 文件就位
- FastAPI 0.133.1 + Pydantic 2.12.5 已安装并验证可运行
- `backend/app/main.py` 已包含 FastAPI 实例和 CORS 配置
- `backend/tests/__init__.py` 已存在
- 使用 `pipenv run pytest` 运行测试

### References

- [Source: _bmad-output/planning-artifacts/architecture.md#Data Architecture] — 6 个核心数据模型定义
- [Source: _bmad-output/planning-artifacts/architecture.md#Communication Patterns] — 枚举值定义（action_type、status、channel）
- [Source: _bmad-output/planning-artifacts/architecture.md#API & Communication Patterns] — 轮询响应结构和错误响应格式
- [Source: _bmad-output/planning-artifacts/architecture.md#Structure Patterns] — 后端目录结构和文件组织
- [Source: _bmad-output/planning-artifacts/architecture.md#Implementation Patterns & Consistency Rules] — 命名规范
- [Source: _bmad-output/planning-artifacts/architecture.md#Architectural Boundaries] — Store 是唯一状态读写点
- [Source: _bmad-output/planning-artifacts/epics.md#Story 1.2] — 验收标准
- [Source: _bmad-output/planning-artifacts/prd.md#Functional Requirements] — FR 需求列表
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Component Strategy] — ActionLogItem 状态定义（执行中/成功/失败）
- [Source: _bmad-output/implementation-artifacts/1-1-项目初始化与开发环境搭建.md] — 前置 Story 完成状态和文件清单

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References

无异常，所有步骤一次通过。

### Completion Notes List

- Task 1: 在 `backend/app/schemas/models.py` 中定义 4 个枚举类型（ActionType 6 值、ActionStatus 3 值、SessionStatus 4 值、Channel 3 值），全部使用 `str, Enum` 双继承确保 JSON 序列化输出字符串值
- Task 2: 定义 6 个 Pydantic v2 数据模型（ActionLogEntry、ChannelMessage、AgentExecutionState、SkillDefinition、ToolDefinition、ExecutionHistory），使用 `Field(default_factory=...)` 处理 datetime 和 list 默认值，可选字段使用 `str | None = None` 语法
- Task 3: 在 `backend/app/store/memory.py` 实现 MemoryStore 类，包含会话管理（create/get/update/set_final_reply）、动作日志（add_action 自增 index + get_actions 增量查询）、消息管理（add/get by channel）、未读频道管理、历史记录（深拷贝快照）、会话清空（保留历史）功能，导出模块级 `store` 单例
- Task 4: 编写 45 个单元测试覆盖全部 6 条 AC — test_models.py（20 tests：枚举值验证、模型创建、字段默认值、JSON 序列化）+ test_store.py（25 tests：会话 CRUD、动作日志增量查询、按频道消息查询、未读管理、历史快照独立性、清空重置含计数器归零）
- 安装 pytest 作为 dev 依赖

**Code Review 修复（2026-02-26）：**
- [H1] `create_session()` 现在清除 `_messages`，防止旧消息泄漏到新会话
- [M1] 所有 datetime 默认值改用 `datetime.now(UTC)` 生成 UTC 时间戳，符合架构文档 ISO 8601 UTC 规范
- [M2] `add_action`/`update_session_status`/`set_final_reply`/`update_action_status` 在无活跃会话时抛出 `ValueError`，不再静默失败
- [M3] `save_execution_history` 新增 `skill_name` 参数，由调用者显式传入，移除从 action title 推断的脆弱逻辑
- 新增 9 个测试覆盖上述修复（总计 54 个测试全部通过）

### File List

**新增文件:**
- backend/app/schemas/models.py
- backend/app/store/memory.py
- backend/tests/test_models.py
- backend/tests/test_store.py

**修改文件:**
- backend/Pipfile（添加 pytest dev 依赖）
- backend/Pipfile.lock（更新锁文件）

## Change Log

- 2026-02-26: 完成 Story 1.2 全部 4 个 Task — 定义 4 个枚举、6 个 Pydantic v2 数据模型、MemoryStore 内存存储模块（含增量查询和深拷贝历史快照），编写 45 个单元测试全部通过。
- 2026-02-26: Code Review 修复 4 个问题（1 High + 3 Medium）— UTC 时间戳、消息泄漏、静默失败、skill_name 参数化。新增 9 个测试，总计 54 个测试通过。
