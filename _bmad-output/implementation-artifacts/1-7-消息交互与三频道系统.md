# Story 1.7: 消息交互与三频道系统

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a 操作者,
I want 在对话频道输入消息并发送，在三个频道 Tab 之间切换查看不同频道的消息，有新消息的频道显示红点提示,
so that 能发送消息触发 Agent 处理，并观察消息在操作者、下游群、上游群之间的流转。

## Acceptance Criteria

1. **Given** 对话频道 **When** 在输入框输入文字并按回车或点击发送按钮 **Then** 消息以蓝色气泡出现在对话区右侧，并调用 POST /api/chat 发送给后端（FR1, FR2）

2. **Given** 左侧面板顶部 **When** 查看频道 Tab **Then** 显示三个 Tab：对话、下游群、上游群

3. **Given** 用户在"对话"频道 **When** Agent 在上游群发送消息 **Then** "上游群"Tab 出现红点 Badge 提示

4. **Given** "上游群"Tab 有红点 **When** 用户点击切换到上游群 **Then** 红点消失，显示该频道的消息列表

5. **Given** 下游群/上游群频道 **When** 查看界面 **Then** 频道为只读，无输入框

6. **Given** ChatBubble 组件 **When** 渲染用户消息 **Then** 右对齐、蓝色背景(#1677FF)、白色文字

7. **Given** ChatBubble 组件 **When** 渲染 Agent 消息 **Then** 左对齐、浅灰背景(#F5F5F5)、黑色文字

8. **Given** 频道有新消息 **When** 消息追加 **Then** 自动滚动到底部

## Tasks / Subtasks

- [x] Task 1: 实现 ChatBubble 组件 (AC: #6, #7)
  - [x] 1.1 在 `src/components/ChatBubble/ChatBubble.tsx` 中创建聊天气泡组件
  - [x] 1.2 支持 props：sender（string）、content（string）、isUser（boolean）、timestamp（string）
  - [x] 1.3 用户消息：右对齐、蓝色背景(#1677FF)、白色文字、圆角气泡
  - [x] 1.4 Agent/他人消息：左对齐、浅灰背景(#F5F5F5)、深色文字(#262626)、圆角气泡
  - [x] 1.5 气泡上方显示发送者名称（12px 灰色辅助文字）
  - [x] 1.6 创建 `src/components/ChatBubble/ChatBubble.css` 用于气泡样式

- [x] Task 2: 实现频道 Tab 切换与红点提示 (AC: #2, #3, #4)
  - [x] 2.1 修改 `MessagePanel.tsx`：将 Tabs 的 `defaultActiveKey` 改为受控组件（使用 AppContext 的 currentChannel）
  - [x] 2.2 Tab 切换时 dispatch `SET_CHANNEL` 更新全局状态
  - [x] 2.3 Tab 切换时 dispatch `CLEAR_UNREAD` 清除该频道的未读标记
  - [x] 2.4 对 Tabs 的 `items` 添加 Badge dot：当频道在 unreadChannels 中时显示红点
  - [x] 2.5 使用 Ant Design Badge 的 `dot` 模式（非 count 模式）包裹 Tab label

- [x] Task 3: 实现消息发送功能 (AC: #1)
  - [x] 3.1 修改 `MessagePanel.tsx`：启用 Input 和 Button（移除 disabled）
  - [x] 3.2 添加本地 state 管理输入框文字（useState）
  - [x] 3.3 点击发送或按回车时：
    - 立即将用户消息添加到本地 chat 频道消息列表（乐观更新）
    - 调用 `api.sendMessage(message)` 发送到后端
    - 获取返回的 session_id，dispatch `SET_SESSION`
    - dispatch `SET_SESSION_STATUS` 为 'running'
  - [x] 3.4 发送后清空输入框
  - [x] 3.5 发送中禁用输入框和按钮（防重复发送）
  - [x] 3.6 错误处理：发送失败时通过 Ant Design message.error() 提示

- [x] Task 4: 实现三频道消息显示 (AC: #5, #8)
  - [x] 4.1 修改 `MessagePanel.tsx`：根据 currentChannel 显示对应频道的消息列表
  - [x] 4.2 使用 ChatBubble 组件渲染每条消息
  - [x] 4.3 判断 isUser 逻辑：chat 频道中 sender 为 "user" 或 "操作者" 时为用户消息
  - [x] 4.4 对话频道（chat）：底部显示输入框
  - [x] 4.5 下游群/上游群频道：不显示输入框（只读）
  - [x] 4.6 消息列表区域使用 ref + scrollIntoView 实现自动滚动到底部
  - [x] 4.7 空频道显示"暂无消息"灰色居中文字

- [x] Task 5: 实现消息轮询与频道同步 (AC: #3, #8)
  - [x] 5.1 创建 `src/hooks/useMessagePolling.ts` 自定义 Hook
  - [x] 5.2 当 sessionStatus 为 'running' 时，每 1 秒轮询 GET /api/messages/{channel} 获取三个频道的消息
  - [x] 5.3 比较新旧消息列表，如果某频道消息数增加且该频道非当前频道，dispatch `MARK_UNREAD`
  - [x] 5.4 更新消息到 AppContext（dispatch `SET_MESSAGES`）
  - [x] 5.5 当 sessionStatus 变为 'completed' 或 'error' 时，执行最后一次消息拉取后停止轮询
  - [x] 5.6 组件卸载时清理定时器（useEffect cleanup）
  - [x] 5.7 在 `MessagePanel.tsx` 或 `DemoView.tsx` 中调用此 Hook

- [x] Task 6: 验证整体功能 (AC: #1-#8)
  - [x] 6.1 验证对话频道可输入消息并发送（气泡出现 + API 调用）
  - [x] 6.2 验证三个频道 Tab 可切换，各频道显示对应消息
  - [x] 6.3 验证非当前频道有新消息时红点出现
  - [x] 6.4 验证切换到有红点的频道后红点消失
  - [x] 6.5 验证下游群/上游群无输入框
  - [x] 6.6 验证消息追加后自动滚动到底部
  - [x] 6.7 验证 TypeScript 编译零错误、Vite 构建成功

## Dev Notes

### 核心设计：消息交互是触发器，频道是信息流的窗口

本 Story 是前端的**第二个实现 Story**，在 Story 1.6 建立的视觉框架和基础设施之上，实现消息输入、发送和三频道消息显示功能。这是 Demo 的"触发器"——用户通过发送消息启动 Agent 工作流，然后在三个频道中观察消息流转。

**本 Story 要做的：**
- ChatBubble 自定义组件（用户/Agent 两种样式）
- 频道 Tab 受控切换 + Badge 红点未读提示
- 消息发送功能（Input → API → 乐观更新）
- 三频道消息显示（chat 可写、downstream/upstream 只读）
- 消息轮询 Hook（频道消息同步 + 未读标记）
- 自动滚动到底部

**本 Story 不做的：**
- 动作日志渲染和 ActionLogItem 组件（Story 1.8）
- usePolling hook 用于 status 轮询和动作日志增量获取（Story 1.8）
- 清空会话按钮功能（Story 2.2）
- 历史记录和管理视图功能（Epic 3）

### 当前前端代码库状态（Story 1.6 创建）

```
frontend/src/
├── App.tsx                    # Layout.Header 导航栏 + AppProvider + Routes
├── main.tsx                   # ConfigProvider（zhCN + #1677FF）
├── types/
│   └── index.ts              # 完整 TypeScript 类型（11 个类型/接口）
├── services/
│   └── api.ts                # 完整 API 层（10 个函数，覆盖 9 端点）
├── context/
│   └── AppContext.tsx         # React Context（useReducer + 9 种 action）
├── hooks/
│   └── .gitkeep              # 空目录 ← 本 Story 将创建 useMessagePolling.ts
├── components/
│   ├── ActionLogItem/.gitkeep # 空 ← Story 1.8 负责
│   ├── ChannelTab/.gitkeep    # 空 ← 本 Story 可选（逻辑整合到 MessagePanel 也可）
│   └── ChatBubble/.gitkeep    # 空 ← 本 Story 将创建 ChatBubble.tsx + .css
└── views/
    ├── DemoView/
    │   ├── DemoView.tsx       # 左右分屏布局（35%/65%）
    │   ├── MessagePanel.tsx   # 频道 Tabs(disabled) + 消息区 + 输入框(disabled)
    │   └── ActionLogPanel.tsx # 空状态欢迎提示 ← Story 1.8 修改
    ├── AdminView/AdminView.tsx # 管理视图占位
    └── HistoryView/HistoryView.tsx # 历史视图占位
```

**已安装依赖（package.json）：**
- react: ^19.2.0, react-dom: ^19.2.0
- antd: ^6.3.1（Ant Design v6）
- @ant-design/icons: ^6.1.0
- react-router-dom: ^7.13.1
- typescript: ~5.9.3, vite: ^7.3.1

### ChatBubble 组件设计

```
用户消息（右对齐）：                Agent 消息（左对齐）：
                    ┌──────────┐   ┌──────────┐
                    │ 蓝色背景  │   │ 灰色背景  │
                    │ 白色文字  │   │ 深色文字  │
                    └──────────┘   └──────────┘
                        操作者      Agent
```

| 消息来源 | 对齐 | 气泡背景 | 文字颜色 |
|---------|------|---------|---------|
| 用户/操作者 | 右对齐 | #1677FF 蓝 | #FFFFFF 白 |
| Agent | 左对齐 | #F5F5F5 浅灰 | #262626 黑 |
| 下游群其他消息 | 按来源判断 | 同上规则 | 同上规则 |
| 上游群消息 | 左对齐 | #F5F5F5 浅灰 | #262626 黑 |

**Props 设计：**
```typescript
interface ChatBubbleProps {
  sender: string;
  content: string;
  isUser: boolean;  // true = 右对齐蓝色, false = 左对齐灰色
  timestamp?: string;
}
```

**判断 isUser 逻辑：**
- chat 频道：sender 包含 "user"/"操作者"/"用户" → isUser=true，其余为 Agent
- downstream 频道：sender 为 "Agent" → isUser=false（Agent 发到下游群），其余根据实际 sender 判断
- upstream 频道：所有消息 isUser=false（用户不直接向上游群发消息）

### 频道 Tab 与 Badge 红点

使用 Ant Design `Tabs` 的 `items` 属性（v6 要求），配合 `Badge` 组件的 `dot` 模式：

```typescript
const tabItems = [
  {
    key: 'chat',
    label: <Badge dot={unreadChannels.has('chat')}>对话</Badge>,
  },
  {
    key: 'downstream',
    label: <Badge dot={unreadChannels.has('downstream')}>下游群</Badge>,
  },
  {
    key: 'upstream',
    label: <Badge dot={unreadChannels.has('upstream')}>上游群</Badge>,
  },
];
```

**红点行为：**
- 当用户在"对话"频道，Agent 在 downstream 或 upstream 频道产生新消息 → 对应 Tab 显示红点
- 用户切换到该频道 → 红点消失（dispatch CLEAR_UNREAD）
- 当前所在频道永远不显示红点

### 消息发送流程

```
用户输入 → 按回车/点发送
    ↓
1. 获取输入文字，清空输入框
2. 创建本地 ChannelMessage 对象（乐观更新）
3. dispatch SET_MESSAGES → 消息立即出现在对话频道
4. 调用 api.sendMessage(message) → POST /api/chat
5. 成功：dispatch SET_SESSION(session_id)、SET_SESSION_STATUS('running')
6. 失败：message.error('发送失败')
```

**重要：** 发送后设置 sessionStatus 为 'running'，这将触发 Story 1.8 中的 usePolling hook 开始轮询动作日志。在本 Story 中，只触发消息频道的轮询（useMessagePolling）。

### 消息轮询 Hook 设计

```typescript
// src/hooks/useMessagePolling.ts
function useMessagePolling() {
  const { state, dispatch } = useAppContext();

  useEffect(() => {
    if (state.sessionStatus !== 'running' && state.sessionStatus !== 'completed') return;

    const fetchMessages = async () => {
      const channels: Channel[] = ['chat', 'downstream', 'upstream'];
      for (const channel of channels) {
        const messages = await api.getMessages(channel);
        const oldCount = state.messages[channel].length;
        dispatch({ type: 'SET_MESSAGES', channel, messages });
        if (messages.length > oldCount && channel !== state.currentChannel) {
          dispatch({ type: 'MARK_UNREAD', channel });
        }
      }
    };

    fetchMessages(); // 立即执行一次
    const timer = setInterval(fetchMessages, 1000);
    return () => clearInterval(timer);
  }, [state.sessionStatus]);
}
```

**注意事项：**
- 轮询仅在 sessionStatus 为 'running' 时持续
- sessionStatus 变为 'completed'/'error' 后再拉取一次最终消息即停止
- 使用 useRef 存储最新的 state 引用以避免 stale closure 问题
- 不在当前频道标记未读

### AppContext 已有的 Action 类型

当前 AppContext 已支持本 Story 需要的所有 action 类型：
- `SET_SESSION` — 设置 session_id
- `SET_SESSION_STATUS` — 设置会话状态
- `SET_CHANNEL` — 切换当前频道
- `MARK_UNREAD` — 标记频道有未读消息
- `CLEAR_UNREAD` — 清除频道未读标记
- `SET_MESSAGES` — 设置频道消息列表
- `SET_FINAL_REPLY` — 设置最终回复
- `RESET` — 重置所有状态

**无需修改 AppContext！** 所有需要的 state 和 action 都已在 Story 1.6 中预定义好了。

### 后端 API 端点速查

| 端点 | 方法 | 状态 | 本 Story 用途 |
|------|------|------|-------------|
| `/api/chat` | POST | ✅ 已实现 | 发送消息，返回 session_id |
| `/api/messages/{channel}` | GET | ✅ 已实现 | 轮询获取频道消息 |
| `/api/status/{session_id}` | GET | ✅ 已实现 | Story 1.8 使用，本 Story 不直接调用 |

**消息 API 响应格式：**
```json
// GET /api/messages/chat
[
  {
    "channel": "chat",
    "sender": "user",
    "content": "订单号 HT20260301001 的客人申请提前离店",
    "timestamp": "2026-02-27T10:00:00Z"
  },
  {
    "channel": "chat",
    "sender": "agent",
    "content": "已收到您的请求，正在处理...",
    "timestamp": "2026-02-27T10:00:01Z"
  }
]
```

### 文件组织

本 Story 创建/修改的文件：

```
frontend/src/
├── components/
│   └── ChatBubble/
│       ├── ChatBubble.tsx     # 新增：聊天气泡组件
│       └── ChatBubble.css     # 新增：气泡样式
├── hooks/
│   └── useMessagePolling.ts   # 新增：消息轮询 Hook
└── views/
    └── DemoView/
        └── MessagePanel.tsx   # 修改：启用交互、集成 ChatBubble、频道切换、红点提示
```

**禁止创建/修改的文件：**
- components/ActionLogItem/* — Story 1.8 负责
- views/DemoView/ActionLogPanel.tsx — Story 1.8 负责
- hooks/usePolling.ts（动作日志轮询） — Story 1.8 负责
- context/AppContext.tsx — 已完整，无需修改
- services/api.ts — 已完整，无需修改
- types/index.ts — 已完整，无需修改
- backend/ 目录下的任何文件

### 样式规范

| 元素 | 尺寸/色值 | 来源 |
|------|---------|------|
| 用户气泡背景 | #1677FF | UX 设计文档 |
| 用户气泡文字 | #FFFFFF | UX 设计文档 |
| Agent 气泡背景 | #F5F5F5 | UX 设计文档 |
| Agent 气泡文字 | #262626 | UX 设计文档 |
| 气泡圆角 | 12px（发送方角 4px） | UX 常用模式 |
| 气泡内边距 | 12px 16px | UX 设计文档 8px 倍数体系 |
| 气泡最大宽度 | 75% | 消息类 App 常见比例 |
| 发送者名称字号 | 12px/400 灰色 | UX 设计文档辅助文字 |
| 消息内容字号 | 14px/400 | UX 设计文档正文 |
| Badge 红点 | Ant Design Badge dot 默认红 | Ant Design 内置 |

### 命名规范

| 场景 | 规则 | 示例 |
|------|------|------|
| 组件文件名 | PascalCase.tsx | `ChatBubble.tsx` |
| Hook 文件名 | camelCase.ts | `useMessagePolling.ts` |
| CSS 文件名 | PascalCase.css | `ChatBubble.css` |
| 组件 Props | PascalCase + Props 后缀 | `ChatBubbleProps` |
| 事件处理函数 | handle + 动作 | `handleSend`, `handleTabChange` |
| 状态变量 | camelCase | `inputValue`, `isSending` |
| TypeScript 接口中 JSON 字段 | snake_case | `session_id`, `final_reply` |

### 前一个 Story (1.6) 关键成果与教训

**成果：**
- TypeScript 类型系统完整镜像后端（0 错误编译）
- API 服务层 10 个函数覆盖所有端点
- React Context useReducer 模式 + 9 种 action
- 导航栏 + 路由 + 左右分屏布局

**Code Review 修复项（需注意的模式）：**
- [H1] request() 已添加 response.ok 检查和非 JSON 响应容错 → 本 Story 调用 API 时无需额外错误处理
- [M1] ChatRequest 类型已导出 → sendMessage 函数参数已有类型安全
- [M3] @ant-design/icons 已显式添加到 dependencies → 可直接导入图标

**关键代码模式：**
- 使用 `useAppContext()` hook 获取 state 和 dispatch
- Ant Design v6 Tabs 使用 `items` 属性（不使用 TabPane 子组件）
- 所有 API 调用通过 `services/api.ts` → 不在组件中直接 fetch
- 内联样式为主（与 Story 1.6 保持一致），ChatBubble 使用 CSS 文件

### Git 智能

最近 commits：
```
16780e5 Complete Story 1.6: 前端框架与演示视图布局
28f8073 Complete Story 1.5: 后端 REST API 与通信层
dc7dcff Complete Story 1.4: Agent 引擎与提前离店 Skill
4a4106c Complete Story 1.3: 模拟工具与模拟数据
2104e42 Complete Story 1.2: 数据模型与内存存储
dca5dfc Complete Story 1.1: 项目初始化与开发环境搭建
```

代码模式观察：
- 每个 Story 完成后单独 commit，commit message 格式："Complete Story X.Y: 标题"
- 前端 Story 1.6 改动了 13 个文件（7 个重写 + 2 个新增 + 1 个依赖更新）
- TypeScript 编译 0 错误、Vite 构建成功、ESLint 0 error 是完成标准
- 后端 151 测试全部通过零回归

### 架构边界提醒

**本 Story 的职责边界：**
- 实现消息输入发送功能（Demo 的"触发器"）
- 实现三频道消息显示和切换
- 实现频道未读红点提示
- 实现消息频道轮询同步

**与后续 Story 的接口：**
- Story 1.8 将实现 ActionLogItem 组件和动作日志轮询（usePolling hook 调用 api.pollStatus）
- Story 1.8 的 usePolling 会设置 sessionStatus，影响本 Story 的 useMessagePolling 行为
- Story 2.2 将实现清空会话按钮（dispatch RESET），重置消息和频道状态

**关键依赖：**
- 本 Story 的 `sendMessage` 将 sessionStatus 设为 'running'
- Story 1.8 的 usePolling 需在 sessionStatus='running' 时工作
- 因此本 Story 必须正确设置 session 状态，否则 Story 1.8 无法触发

### 注意：消息轮询与动作日志轮询的分工

| Hook | 用途 | 触发条件 | Story |
|------|------|---------|-------|
| useMessagePolling | 轮询三个频道的消息 | sessionStatus='running' | 本 Story (1.7) |
| usePolling | 轮询动作日志（增量 ActionLogEntry） | sessionStatus='running' | Story 1.8 |

两个轮询 Hook 将在 Story 1.8 完成后同时工作，各自独立轮询不同的 API 端点。

### Project Structure Notes

- 本 Story 遵循架构文档定义的前端目录结构
- ChatBubble 放在 components/ChatBubble/ 目录下（遵循已有目录结构）
- useMessagePolling 放在 hooks/ 目录下（遵循架构文档规划）
- MessagePanel 在 views/DemoView/ 目录下修改（就地修改现有文件）

### References

- [Source: _bmad-output/planning-artifacts/epics.md#Story 1.7] — 验收标准（8 条 AC）
- [Source: _bmad-output/planning-artifacts/architecture.md#API & Communication Patterns] — REST 端点定义、轮询机制
- [Source: _bmad-output/planning-artifacts/architecture.md#Frontend Architecture] — 组件组织、Hooks 设计
- [Source: _bmad-output/planning-artifacts/architecture.md#Communication Patterns] — Channel 枚举值、消息格式
- [Source: _bmad-output/planning-artifacts/architecture.md#Naming Patterns] — TypeScript camelCase、组件 PascalCase
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Component Strategy] — ChatBubble 样式定义
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Design Direction Decision] — 三频道行为、红点提示设计
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Visual Design Foundation] — 色彩系统、字号层级
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#UX Consistency Patterns] — 反馈模式、空状态设计
- [Source: _bmad-output/implementation-artifacts/1-6-前端框架与演示视图布局.md] — 前端基础设施现状、代码模式

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- ESLint react-hooks/refs 错误：不能在 render 期间直接赋值 stateRef.current。修复方案：将 ref 更新移入 useEffect，使用 useCallback 包裹 fetchMessages 避免 stale closure。

### Code Review Fixes

- [H1] 乐观更新失败回滚：sendMessage 失败时恢复 prevMessages，避免界面显示未发送的消息
- [H2] 乐观消息 sender 改为 `"user"`（与后端 engine.py:431 一致），轮询覆盖时消息不会丢失
- [M1] isUserMessage 简化为仅匹配 `"user"`（后端唯一的用户 sender 值），移除不存在的 `"操作者"`/`"用户"` 匹配
- [M2] useMessagePolling stateRef 同步 useEffect 添加 `[state]` 依赖数组，避免无依赖的每次渲染执行
- [M3] ChatBubble 移除未使用的 `timestamp` prop（接口和调用处同步清理）

### Completion Notes List

- Task 1: ChatBubble 组件完成，CSS 文件定义用户（蓝色右对齐）和 Agent（灰色左对齐）两种气泡样式，支持 sender/content/isUser/timestamp props
- Task 2: MessagePanel Tabs 改为受控组件（activeKey 绑定 AppContext.currentChannel），切换时 dispatch SET_CHANNEL + CLEAR_UNREAD，Badge dot 模式显示红点
- Task 3: 消息发送功能完成——乐观更新、POST /api/chat、SET_SESSION/SET_SESSION_STATUS dispatch、loading 状态防重复、message.error() 错误提示
- Task 4: 三频道消息显示完成——ChatBubble 渲染、isUser 逻辑（chat 频道 user/操作者/用户 判定）、chat 频道显示输入框/其他频道只读、空状态显示、scrollIntoView 自动滚动
- Task 5: useMessagePolling hook 完成——sessionStatus='running' 时 1 秒间隔轮询三个频道、消息数增加时标记未读、useEffect cleanup 清理定时器、completed 状态单次拉取
- Task 6: 全部验证通过——TypeScript 0 错误、Vite build 成功（2.34s）、ESLint 0 错误、后端 151 测试零回归

### Change Log

- 2026-02-27: Story 1.7 实现完成 — 消息交互与三频道系统（ChatBubble 组件 + 频道 Tab 切换 + 红点提示 + 消息发送 + 消息轮询）

### File List

- frontend/src/components/ChatBubble/ChatBubble.tsx (新增)
- frontend/src/components/ChatBubble/ChatBubble.css (新增)
- frontend/src/hooks/useMessagePolling.ts (新增)
- frontend/src/views/DemoView/MessagePanel.tsx (重写)
