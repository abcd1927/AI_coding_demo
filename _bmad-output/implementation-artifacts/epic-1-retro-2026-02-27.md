# Epic 1 回顾：提前离店完整演示

**日期：** 2026-02-27
**Epic：** Epic 1 — 提前离店完整演示
**完成度：** 8/8 Stories (100%)
**参与者：** Alice (PM), Bob (SM), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Admin (Project Lead)

---

## 交付指标

| 指标 | 数值 |
|------|------|
| Stories 完成 | 8/8 (100%) |
| 后端测试 | 151 全部通过 |
| 前端编译 | TypeScript 0 error |
| 前端构建 | Vite build 成功 |
| ESLint | 0 error |
| Code Review 修复 | ~35 项（~8 HIGH, ~15 MEDIUM, ~12 LOW） |

## Story 交付明细

| Story | 标题 | Tasks | 测试增量 | Code Review | 关键成果 |
|-------|------|-------|---------|-------------|---------|
| 1.1 | 项目初始化与开发环境搭建 | 6/6 | 0 | 6 项修复 | Vite + React + TS + FastAPI + LangGraph 骨架 |
| 1.2 | 数据模型与内存存储 | 4/4 | +54 | 4 项（1H+3M） | 4 枚举 + 6 Pydantic 模型 + MemoryStore |
| 1.3 | 模拟工具与模拟数据 | 8/8 | +39 → 93 | 5 项（1H+4M） | BaseTool 基类 + 3 工具 + 工具注册表 |
| 1.4 | Agent 引擎与提前离店 Skill | 9/9 | +33 → 126 | 6 项（3H+3M） | LangGraph 状态图 + Skill 注册表 + run_agent |
| 1.5 | 后端 REST API 与通信层 | 6/6 | +25 → 151 | 6 项（1H+2M+3L） | 3 路由 + 统一错误处理 |
| 1.6 | 前端框架与演示视图布局 | 7/7 | 0（前端） | 6 项（2H+4M） | 类型系统 + API 层 + Context + 导航 + 布局 |
| 1.7 | 消息交互与三频道系统 | 6/6 | 0（前端） | 5 项（2H+3M） | ChatBubble + 频道切换 + 消息轮询 |
| 1.8 | 动作日志可视化与端到端联调 | 5/5 | 0（前端） | 4 项（1H+1M+1L） | ActionLogItem + usePolling + Timeline |

## 做得好的（Keep Doing）

### 1. 清晰的验收标准定义
每个 Story 使用 Given-When-Then 格式 + 精确技术规格定义 AC，减少需求歧义。Story 1.2 定义的枚举值和字段类型被后续所有 Story 直接复用。

### 2. 正确的架构决策
- **轻量图状态 + MemoryStore 侧效应模式**：LangGraph 状态仅携带路由信号，详情通过 Store 管理，避免了列表管理复杂度
- **Store 作为唯一状态权威来源**：全栈（Agent → Router → 前端）通过 Store 读写，零状态不一致
- **薄路由层**：Router 只做 I/O 桥接，Story 1.5 几乎零 debug

### 3. 渐进式 Story 依赖链
```
1.1 骨架 → 1.2 数据模型 → 1.3 工具 → 1.4 引擎 → 1.5 API → 1.6 前端框架 → 1.7 消息 → 1.8 可视化
```
每个 Story 可独立验证，构建风险最小化。

### 4. Code Review 作为质量门禁
每个 Story 必过 Review，累计发现并修复 ~35 个问题，包含多个功能性 bug（消息泄漏、无限循环风险、响应数据丢弃等）。Review 的 ROI 极高。

### 5. 测试驱动的后端开发
测试增长曲线健康：0 → 54 → 93 → 126 → 151。每个后端 Story 增加测试并验证零回归。

## 需改进的（Start/Stop/Change）

### 1. 错误处理系统性缺失（反复出现）
几乎每个 Story 的 Code Review 都发现错误处理问题：
- Story 1.2: 无会话时操作静默失败
- Story 1.3: RefundTool 始终返回成功、MessageSendTool 接受空内容
- Story 1.5: 缺少 RequestValidationError 处理器
- Story 1.6: response.ok 未检查
- Story 1.7: 乐观更新无回滚

**根因：** Happy path 开发思维。AC 定义了成功场景，但对异常场景覆盖不够系统。

### 2. 第三方库集成缺少前期验证
Story 1.4 的 LangChain 工具包装遇到 `@langchain_tool` 装饰器与参数解析冲突，被迫在开发中切换到 `StructuredTool.from_function()` 方案。若提前做 Spike 验证可避免。

### 3. React Hooks stale closure 重复出现
Story 1.7 和 1.8 都遇到相同的闭包捕获旧状态问题，需要 `useRef` + `useEffect([state])` 模式。虽然 Story 1.7 的 Review 标注了模式，Story 1.8 仍需额外注意。

### 4. 前端测试为零
151 个测试全在后端。前端靠 TypeScript 编译 + ESLint + 手动验证。Demo 阶段可接受，但风险随复杂度增长累积。

### 5. Code Review HIGH 级别问题过多
几乎每个 Story 都有至少 1 个 HIGH 级别问题。这些是功能性 bug，不是代码风格问题。需要前置防护而非事后捕获。

## 行动项

| # | 行动项 | 负责人 | 验收标准 | 适用范围 |
|---|--------|--------|---------|---------|
| A1 | Story AC 显式包含异常路径（每个 Story ≥1 条异常 AC） | Alice (PM) | Epic 2 每个 Story 有异常场景 AC | Epic 2+ |
| A2 | 整理前端开发模式备忘录（stale closure、Ant Design v6、async hooks） | Elena (Dev) | 文档创建并写入项目 Dev Notes | Epic 2 开始前 |
| A3 | 新第三方库集成前做独立 Spike 验证 | Charlie (Dev) | 在需要时提前安排 Spike Story | 按需 |
| A4 | Epic 3 引入前端组件测试 | Dana (QA) | Epic 3 前端 Story 包含测试要求 | Epic 3 |

## Epic 2 准备度评估

**Epic 2: 多场景支持与异常处理**（2 Stories）

| 检查项 | 状态 |
|--------|------|
| Epic 1 全部完成 | 8/8 Done |
| 后端测试全部通过 | 151/151 Pass |
| 前端编译和构建正常 | TS 0 error, Build OK |
| 架构支持新 Skill 扩展 | 自动发现机制就绪 |
| PRD 需求已定义 | FR13-FR15, FR33-FR34 |
| 行动项已分配 | A1-A4 确认 |

**风险评估：低。** 两个 Story 都在已有架构上做增量，没有新的技术集成。

### Story 2.1: 订单取消场景
- 新增 order_cancel 工具和 Skill .md
- 利用现有工具注册表自动发现 + Skill 注册表自动扫描
- 前端零改动（ActionLogPanel 自动渲染任何 ActionLogEntry）

### Story 2.2: 未匹配意图处理与会话重置
- 实现 DELETE /api/session 端点
- 前端"清空会话"按钮功能化（dispatch RESET）
- 未匹配意图友好回复（Story 1.4 已有基础版）

### 需关注的边界场景
- 会话重置时 Agent 正在运行的处理
- 新 Skill 无需改核心代码的可扩展性验证（NFR4）
- 订单取消的异常路径（无效订单、已取消订单）

**结论：Epic 2 准备就绪，可以开始。**

## 核心收获

1. **架构设计质量决定后续效率** — MemoryStore 单一状态源、轻量图状态、薄路由层三个决策让 8 个 Story 集成顺滑
2. **Code Review 是不可或缺的质量门禁** — 35 个修复中包含多个功能性 bug，Review 的 ROI 极高
3. **错误处理需要前置到 AC 层面** — 本次回顾最重要的改进方向
4. **渐进式构建 + 零回归测试 = 信心** — 从 0 到 151 测试，每个 Story 都在已验证的基础上增量
